<html>
	<head>
        <meta charset="utf-8"/>
        <!--scales viewport depending on worldspace device width-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		
        <meta name="description" content="Multilingual wordsearch generator."/>
        <meta name="author" content="Owen Gallagher <github.com/ogallagher>"/>
		<meta name="page-name" content="wordsearch_generator.html"/>
		
		<!-- bootstrap css -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
		
		<link href="/wordsearch_generator.css" rel="stylesheet"/>
		
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>
		
		<script src="/wordsearch_generator.cjs" type="text/javascript"></script>
		<script type="text/javascript">
			const INPUT_FILE = 0
			const INPUT_FORM = 1
			let wordsearch_input_type
			let wordsearch_is_random_subset
			
			let endpoint_cells = []
			
			window.onload = function(e) {
				set_wordsearch_input_type(INPUT_FILE)
				set_wordsearch_is_random_subset(false)
				
				// handle input choice
				$('#wordsearch-input-file').click(function() {
					set_wordsearch_input_type(INPUT_FILE)
				})
				$('#wordsearch-input-form').click(function() {
					set_wordsearch_input_type(INPUT_FORM)
				})
				
				// handle description file upload
				let description_json
				$('.wordsearch-file').on('change', function() {
					let filereader = new FileReader()
					filereader.onload = function() {
						description_json = filereader.result
						on_wordsearch_input_file(description_json)
					}
					filereader.readAsText($(this).prop('files')[0])
				})
				
				// handle reload button
				$('.wordsearch-reload').click(function() {
					on_wordsearch_input_file(description_json)
				})
				
				// handle word-clue add button click
				$('#add-word-clue').click(function() {
					let containerjq = $('#word-clues')
					let rowjq = $(
						`<div class="row word-clue mt-1">
							<div class="col">
								<input type="text" placeholder="word" class="word-clue-word form-control"/>
							</div>
							<div class="col">
								<input type="text" placeholder="clue (optional)" class="word-clue-clue form-control"/>
							</div>
						</div>`
					)
					containerjq.append(rowjq)
				})
				
				// handle random subset button click
				$('#random-subset').click(function() {
					set_wordsearch_is_random_subset(!is_on($(this)))
				})
			}
			
			function set_wordsearch_input_type(input_type) {
				wordsearch_input_type = input_type
				
				switch (input_type) {
					case INPUT_FILE:
						$('#wordsearch-input-file').removeClass('btn-outline-secondary').addClass('btn-secondary')
						$('#wordsearch-input-form').removeClass('btn-secondary').addClass('btn-outline-secondary')
						$('.wordsearch-file').show()
						$('.wordsearch-form').hide()
						break
						
					case INPUT_FORM:
						$('#wordsearch-input-file').removeClass('btn-secondary').addClass('btn-outline-secondary')
						$('#wordsearch-input-form').removeClass('btn-outline-secondary').addClass('btn-secondary')
						$('.wordsearch-file').hide()
						$('.wordsearch-form').show()
						break
				}
			}
			
			function set_wordsearch_is_random_subset(is_random) {
				wordsearch_is_random_subset = is_random
				
				// update button data
				$('#random-subset')
				.attr('data-on', is_random)
				.addClass(is_random ? 'btn-secondary' : 'btn-outline-secondary')
				.removeClass(is_random ? 'btn-outline-secondary' : 'btn-secondary')
				
				if (is_random) {
					$('#random-subset-count').prop('disabled', false)
				}
				else {
					$('#random-subset-count').prop('disabled', true)
				}
			}
			
			function on_wordsearch_input_file(wordsearch_json) {
				if (wordsearch_json != undefined) {
					let description = JSON.parse(wordsearch_json)
					let wordsearch = new WordsearchGenerator(
						description['language'],
						description['case'],
						description['size']
					)
					wordsearch.init_promise.then(() => {
						load_word_clues(wordsearch, description['words'])
					
						display_wordsearch(wordsearch)
					})
				}
				else {
					console.log('ERROR wordsearch description not defined')
				}
			}
			
			function load_word_clues(wordsearch, word_clues, clue_delim=':') {
				if (wordsearch_is_random_subset) {
					let subset_count_jq = $('#random-subset-count')
					if (subset_count_jq.val() == '') {
						subset_count_jq.val(word_clues.length)
					}
					
					// show answer count in random subset input
					let subset_length = parseInt(subset_count_jq.val())
					
					// get random subset of words and clues
					if (subset_length < word_clues.length && subset_length > 0) {
						let subset_idx = new Set()
						while (subset_idx.size < subset_length) {
							subset_idx.add(Math.floor(Math.random() * word_clues.length))
						}
						
						subset_idx = new Array(...subset_idx)
						let subset = new Array(subset_length)
						for (let i=0; i<subset_idx.length; i++) {
							subset[i] = word_clues[subset_idx[i]]
						}
						
						word_clues = subset
					}
				}
				else {
					$('#random-subset-count').val('')
				}
				
				for (let word_clue of word_clues) {
					let array = word_clue.split(clue_delim)
		
					let word = array[0]
					let clue = word
					if (array.length == 2) {
						clue = array[1]
					}
					
					if (word.length <= wordsearch.grid.length) {
						if (!wordsearch.add_word_clue(word,clue)) {
							console.log(`ERROR failed to find a place for ${word}`)
						}
					}
					else {
						console.log(
							`ERROR ${word} length ${word.length} longer than board width ${
								wordsearch.grid.length
							}`
						)
					}
				}
			}
			
			function display_wordsearch(wordsearch) {
				// console.log(`DEBUG final grid:\n${wordsearch.grid_string()}`)
				// console.log(`DEBUG clues:\n${wordsearch.clues.join('\n')}`)
				
				// clear endpoint_cells
				endpoint_cells = []
				
				let wel = $('.wordsearch')
				.html('')
				
				let y=0
				for (let row of wordsearch.grid) {
					let rel = $(`
						<div class="row flex-nowrap justify-content-center ws-row"></div>
					`)
					
					let x=0
					for (let cell of row) {
						let cel = $(
							`<div 
								class="col-auto ws-cell"
								data-x="${x}" data-y="${y}" data-word="${cell}"
								data-on="false">
							${cell}
							</div>`
						)
						
						cel.click(function() {
							on_cell_click($(this), wordsearch)
						})
						
						rel.append(cel)
						x++
					}
					
					wel.append(rel)
					y++
				}
				
				display_answers(wordsearch.words, wordsearch.clues)
			}
			
			function display_answers(words, clues) {
				// show answer word-clues
				let answersjq = $('.answers').html('')
				
				for (let i=0; i<words.length; i++) {
					let rowjq = $(
						`<li class="ws-answer" data-word-idx="${i}">
							<span class="ws-clue">${clues[i]}</span> &rarr;
							<span class="ws-word" data-found="false">${words[i]}</span>
						</li>`
					)
					
					answersjq.append(rowjq)
				}
			}
			
			function on_cell_click(cell, wordsearch) {
				// console.log(
				// 	`DEBUG cell ${cell.attr('data-x')},${cell.attr('data-y')}=${
				// 		cell.attr('data-word')
				// 	} clicked`
				// )
				
				let cell_is_on = !is_on(cell)
				cell.attr('data-on', cell_is_on)
				
				if (cell_is_on) {
					if (endpoint_cells.length < 2) {
						// add to endpoint_cells
						endpoint_cells.push(cell)
					}
					
					if (endpoint_cells.length >= 2) {
						// check endpoints
						let ab = 
							`${endpoint_cells[0].attr('data-x')},${endpoint_cells[0].attr('data-y')}-`
							+ `${endpoint_cells[1].attr('data-x')},${endpoint_cells[1].attr('data-y')}`
						
						let word_idx = wordsearch.point_to_word_idx[ab]
						if (word_idx != undefined) {
							console.log(`DEBUG word ${word_idx}=${wordsearch.words[word_idx]} found`)
							let a = endpoint_cells[0]
							.attr('data-on',false)
							
							let b = endpoint_cells[1]
							.attr('data-on',false)
							
							let ax=parseInt(a.attr('data-x')), ay=parseInt(a.attr('data-y'))
							let bx=parseInt(b.attr('data-x')), by=parseInt(b.attr('data-y'))
							let dx=Math.sign(bx-ax), dy=Math.sign(by-ay)
							
							// mark all word cells as found
							for (let x=ax,y=ay; x!=bx+dx || y!=by+dy; ) {
								// console.log(`.ws-cell[data-x="${x}"][data-y="${y}"]`)
								$(`.ws-cell[data-x="${x}"][data-y="${y}"]`)
								.attr('data-found',true)
								
								x += dx
								y += dy
							}
							
							// reveal answer
							$(`.ws-answer[data-word-idx="${word_idx}"] > .ws-word`)
							.attr('data-found', true)
						}
						else {
							console.log(`DEBUG endpoints not a word`)
							for (let ec of endpoint_cells) {
								ec.attr('data-on', false)
							}
						}
						
						// clear endpoint_cells
						endpoint_cells = []
					}
				}
				else {
					// remove from endpoint_cells
					let i = endpoint_cells.indexOf(cell)
					if (i != -1) {
						endpoint_cells.splice(i,1)
					}
				}
			}
			
			function is_on(jq) {
				return jq.attr('data-on') === 'true'
			}
		</script>
		
		<title>
			Multilingual Wordsearch Generator
		</title>
	</head>
	
	<body class="w-100 h-100 bg-dark text-light">
		<header class="container-fluid">
		</header>
		
		<section class="container my-4">
			<div>
				<!-- input config/description method-->
				<div class="row">
					<div class="col">
						<div class="input-group mb-3">
							<button class="btn btn-outline-secondary" id="wordsearch-input-file">
								File
							</button>
							<button class="btn btn-outline-secondary" id="wordsearch-input-form">
								Form
							</button>
						</div>
					</div>
				</div>
				
				<div class="row">
					<div class="col-md mb-3">
						<!-- file input -->
						<input type="file" class="wordsearch-file form-control">
						
						<!-- form input -->
						<div class="wordsearch-form">
							<div class="mb-3">
								<label class="h3" for="language">Language</label>
								<input type="text" id="language" name="language" value="en" class="form-control"/>
							</div>
							
							<div class="mb-3">
								<label class="h3" for="case">Case</label>
								<input type="text" id="case" name="case" value="lower" class="form-control"/>
							</div>
							
							<div class="mb-3">
								<label class="h3" for="size">Size</label>
								<input type="text" id="size" name="size" value="10" class="form-control"/>
							</div>
							
							<div class="">
								<label class="h3" for="word-clues">Words (and clues)</label>
								<div id="word-clues">
								</div>
								<div class="text-center p-2">
									<button class="btn btn-secondary" id="add-word-clue">
										<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
											<path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
										</svg>
									</button>
								</div>
							</div>
						</div>
					</div>
					
					<div class="col-md-5">
						<button class="btn btn-primary wordsearch-reload mb-3">
							Reload
						</button>
						
						<!-- random subset -->
						<div class="input-group">
							<button class="btn btn-outline-secondary" id="random-subset" data-on="false">
								Random subset of
							</button>
							<input type="text" class="form-control" id="random-subset-count" disabled/>
							<span class="input-group-text">words</span>
						</div>
					</div>
				</div>
			</div>
			
			<div class="wordsearch rounded p-2">
			</div>
			
			<h2>Answers</h2>
			<div class="bg-light my-2">
				<ol class="answers">
				</ol>
			</div>
		</section>
		
		<footer class="container-fluid pb-2">
			<a href="https://github.com/ogallagher" class="text-light">Owen Gallagher</a>
		</footer>
	</body>
</html>